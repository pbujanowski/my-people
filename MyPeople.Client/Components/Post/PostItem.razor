@using MyPeople.Services.Posts.Application.Dtos
@using MyPeople.Services.Posts.Application.Services
@inject IPostService PostService

<MudCard>
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">@Post.UserDisplayName</MudText>
            @if (CheckIfPostIsOwnedByCurrentUser())
            {
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="() => EnableEditMode()">Edit</MudButton>
            }
        </CardHeaderContent>
    </MudCardHeader>
        @if (IsEditMode)
        {
            <MudCardContent>
                <MudTextField T="string" Label="Write something..." Variant="Variant.Outlined" @bind-Text="@Post.Content"
                    Lines="5" />
            </MudCardContent>
            <MudCardActions>
                <MudButton Color="Color.Primary" OnClick="() => EditPostAsync()">Send</MudButton>
                <MudButton Color="Color.Default" OnClick="() => DisableEditMode(true)">Cancel</MudButton>
            </MudCardActions>
        }
        else
        {
            <MudCardContent>
                <MudText Typo="Typo.body1">@Post.Content</MudText>
            </MudCardContent>
        }
</MudCard>

@code {
    private PostDto? _oldPost;

    [Parameter, EditorRequired]
    public PostDto Post { get; set; } = default!;

    [Parameter, EditorRequired]
    public Guid CurrentUserId { get; set; }

    [Parameter, EditorRequired]
    public EventCallback OnPostEdit { get; set; }

    public bool IsEditMode { get; set; }

    private bool CheckIfPostIsOwnedByCurrentUser() =>
        Post.UserId == CurrentUserId;

    private void EnableEditMode()
    {
        _oldPost = new PostDto
        {
            Id = Post.Id,
            UserId = Post.UserId,
            CreatedAt = Post.CreatedAt,
            UpdatedAt = Post.UpdatedAt,
            UserDisplayName = Post.UserDisplayName,
            Content = Post.Content
        };
        IsEditMode = true;
    }

    private void DisableEditMode(bool restoreOldPost)
    {
        if (restoreOldPost)
        {
            Post = new PostDto
            {
                Id = _oldPost?.Id,
                UserId = _oldPost?.UserId,
                CreatedAt = _oldPost?.CreatedAt,
                UpdatedAt = _oldPost?.UpdatedAt,
                UserDisplayName = _oldPost?.UserDisplayName,
                Content = _oldPost?.Content
            };
        }
        IsEditMode = false;
    }

    private async Task EditPostAsync()
    {
        await PostService.UpdatePostAsync(Post);
        await OnPostEdit.InvokeAsync();
        DisableEditMode(false);
    }
}
